<!doctype html>
<html>
  <head>
    <title>Test SharedArrayBuffer TextDecoder Fix</title>
  </head>
  <body>
    <h1>Testing SharedArrayBuffer TextDecoder Fix</h1>
    <div id="output"></div>

    <script type="module">
      // Test the SharedStringDecoder utility
      import { SharedStringDecoder } from "./src/lib/shared-string-decoder.js";

      function test() {
        const output = document.getElementById("output");

        // Test 1: Regular ArrayBuffer
        const regularString = "Hello, World! üåç";
        const encoder = new TextEncoder();
        const regularBuffer = encoder.encode(regularString);
        const regularDecoded = SharedStringDecoder.decode(regularBuffer);

        output.innerHTML += `<p>Regular Buffer: ${regularDecoded === regularString ? "‚úÖ PASS" : "‚ùå FAIL"}</p>`;

        // Test 2: SharedArrayBuffer (if available)
        if (typeof SharedArrayBuffer !== "undefined") {
          try {
            const sharedBuffer = new SharedArrayBuffer(regularBuffer.length);
            const sharedView = new Uint8Array(sharedBuffer);
            sharedView.set(regularBuffer);

            const sharedDecoded = SharedStringDecoder.decode(sharedView);
            output.innerHTML += `<p>Shared Buffer: ${sharedDecoded === regularString ? "‚úÖ PASS" : "‚ùå FAIL"}</p>`;

            // Test chunked decoding
            const chunkedDecoded =
              SharedStringDecoder.decodeFromSharedChunked(sharedView);
            output.innerHTML += `<p>Shared Chunked: ${chunkedDecoded === regularString ? "‚úÖ PASS" : "‚ùå FAIL"}</p>`;
          } catch (e) {
            output.innerHTML += `<p>Shared Buffer: ‚ùå ERROR - ${e.message}</p>`;
          }
        } else {
          output.innerHTML += `<p>SharedArrayBuffer not supported in this browser</p>`;
        }

        // Test 3: ASCII optimization
        const asciiString = "CSV data with only ASCII characters";
        const asciiBuffer = encoder.encode(asciiString);
        const asciiDecoded = SharedStringDecoder.decode(asciiBuffer);
        output.innerHTML += `<p>ASCII Buffer: ${asciiDecoded === asciiString ? "‚úÖ PASS" : "‚ùå FAIL"}</p>`;
      }

      // Run tests
      test();
    </script>
  </body>
</html>
