<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parallel Progress Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      textarea {
        width: 100%;
        height: 100px;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .thread-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .thread-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background: #f8f9fa;
      }
      .thread-id {
        font-weight: bold;
        color: #495057;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 5px 0;
      }
      .progress-fill {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <h1>Parallel CSV Progress Test</h1>

    <div class="test-section">
      <h2>Test Configuration</h2>
      <label>
        <input type="checkbox" id="useParallel" checked /> Use Parallel
        Processing
      </label>
      <br /><br />
      <label>
        Thread Count:
        <input type="number" id="threadCount" value="4" min="1" max="8" />
      </label>
      <br /><br />
      <button id="runTest">Run Test</button>
      <button id="clearLogs">Clear Logs</button>
    </div>

    <div class="test-section">
      <h2>Thread Status</h2>
      <div id="threadStatus" class="thread-status"></div>
    </div>

    <div class="test-section">
      <h2>Test Results</h2>
      <div id="testStatus" class="status info">Ready to run test...</div>
      <textarea
        id="logs"
        readonly
        placeholder="Test logs will appear here..."
      ></textarea>
    </div>

    <script type="module">
      // Import the CSV diff functionality
      import init, {
        init_wasm_thread_pool,
        diff_csv_primary_key_parallel,
        diff_csv_parallel_binary,
      } from "./src-wasm/pkg/csv_diff_wasm.js";

      let wasmInitialized = false;
      const logs = document.getElementById("logs");
      const testStatus = document.getElementById("testStatus");
      const threadStatusDiv = document.getElementById("threadStatus");
      const runTestBtn = document.getElementById("runTest");
      const clearLogsBtn = document.getElementById("clearLogs");
      const useParallelCheckbox = document.getElementById("useParallel");
      const threadCountInput = document.getElementById("threadCount");

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        logs.value += `[${timestamp}] ${message}\n`;
        logs.scrollTop = logs.scrollHeight;
        console.log(message);
      }

      function updateTestStatus(message, type = "info") {
        testStatus.textContent = message;
        testStatus.className = `status ${type}`;
      }

      function updateThreadStatus(threads) {
        threadStatusDiv.innerHTML = "";
        threads.forEach((thread) => {
          const card = document.createElement("div");
          card.className = "thread-card";
          card.innerHTML = `
                    <div class="thread-id">Thread ${thread.threadId}</div>
                    <div>Status: ${thread.status}</div>
                    <div>Task: ${thread.currentTask || "N/A"}</div>
                    <div>Progress: ${thread.progress || 0}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${thread.progress || 0}%"></div>
                    </div>
                    <div>Items: ${thread.itemsProcessed || 0} / ${thread.totalItems || 0}</div>
                `;
          threadStatusDiv.appendChild(card);
        });
      }

      function createTestCSV(rowCount, prefix = "A") {
        let csv = "Id,Name,Value,Category\n";
        for (let i = 1; i <= rowCount; i++) {
          csv += `${i},${prefix}-Name-${i},${Math.random() * 100},${["X", "Y", "Z"][i % 3]}\n`;
        }
        return csv;
      }

      // Worker-like progress tracking
      const threadMap = new Map();

      function parseProgressMessage(percent, message) {
        // Parse THREAD_PROGRESS messages
        if (
          typeof message === "string" &&
          message.startsWith("THREAD_PROGRESS|")
        ) {
          const parts = message.split("|");
          if (parts.length === 4) {
            const threadId = parseInt(parts[1], 10);
            const processed = parseInt(parts[2], 10);
            const total = parseInt(parts[3], 10);

            if (!isNaN(threadId)) {
              threadMap.set(threadId, {
                threadId,
                status: "running",
                currentTask: "Processing",
                progress: percent,
                itemsProcessed: processed,
                totalItems: total,
              });
              updateThreadStatus(Array.from(threadMap.values()));
              return true;
            }
          }
        }
        // Parse JSON format
        else if (
          typeof message === "string" &&
          message.startsWith("THREAD_PROGRESS_JSON|")
        ) {
          const jsonStr = message.split("|", 2)[1];
          try {
            const data = JSON.parse(jsonStr);
            if (typeof data.threadId === "number") {
              threadMap.set(data.threadId, {
                threadId: data.threadId,
                status: "running",
                currentTask: "Processing",
                progress: data.globalProgress || percent,
                itemsProcessed: data.processed,
                totalItems: data.perThreadTotal,
              });
              updateThreadStatus(Array.from(threadMap.values()));
              return true;
            }
          } catch (e) {
            log(`Error parsing thread progress: ${e.message}`);
          }
        }
        return false;
      }

      async function initializeWASM() {
        if (wasmInitialized) return;

        updateTestStatus("Initializing WASM...", "info");
        log("Initializing WASM module...");

        try {
          await init();
          wasmInitialized = true;
          updateTestStatus("WASM initialized successfully", "success");
          log("WASM initialized successfully");
        } catch (error) {
          updateTestStatus(
            `Failed to initialize WASM: ${error.message}`,
            "error",
          );
          log(`WASM initialization failed: ${error.message}`);
          throw error;
        }
      }

      async function runTest() {
        try {
          runTestBtn.disabled = true;
          updateTestStatus("Running test...", "info");
          log("=== Starting Parallel Progress Test ===");

          await initializeWASM();

          const useParallel = useParallelCheckbox.checked;
          const threadCount = parseInt(threadCountInput.value, 10);
          const rowCount = 50000;

          log(`Creating test CSVs with ${rowCount} rows each...`);
          const sourceCSV = createTestCSV(rowCount, "A");
          const targetCSV = createTestCSV(rowCount, "B");

          // Initialize thread map
          threadMap.clear();
          for (let i = 0; i < threadCount; i++) {
            threadMap.set(i, {
              threadId: i,
              status: "idle",
              currentTask: "Waiting",
              progress: 0,
              itemsProcessed: 0,
              totalItems: 0,
            });
          }
          updateThreadStatus(Array.from(threadMap.values()));

          if (useParallel) {
            log(`Initializing thread pool with ${threadCount} threads...`);
            try {
              init_wasm_thread_pool(threadCount);
              log(`Thread pool initialized with ${threadCount} threads`);
            } catch (error) {
              log(
                `Warning: Failed to initialize thread pool: ${error.message}`,
              );
            }
          }

          log("Starting primary key comparison...");
          const startTime = Date.now();

          const result = diff_csv_primary_key_parallel(
            sourceCSV,
            targetCSV,
            ["Id"],
            false, // case_sensitive
            false, // ignore_whitespace
            false, // ignore_empty_vs_null
            [], // excluded_columns
            true, // has_headers
            (percent, message) => {
              const isThreadMessage = parseProgressMessage(percent, message);
              if (
                !isThreadMessage &&
                (percent % 10 < 1 || message.includes("Complete"))
              ) {
                log(`[${percent.toFixed(1)}%] ${message}`);
              }
            },
          );

          const endTime = Date.now();
          const duration = (endTime - startTime) / 1000;

          // Mark all threads as completed
          for (let [id, thread] of threadMap) {
            thread.status = "completed";
            thread.currentTask = "Complete";
            thread.progress = 100;
          }
          updateThreadStatus(Array.from(threadMap.values()));

          log(`=== Test Complete ===`);
          log(`Duration: ${duration.toFixed(2)} seconds`);
          log(`Results:`);
          log(`  Added: ${result.added.length}`);
          log(`  Removed: ${result.removed.length}`);
          log(`  Modified: ${result.modified.length}`);
          log(`  Unchanged: ${result.unchanged.length}`);

          updateTestStatus(
            `Test completed successfully in ${duration.toFixed(2)}s`,
            "success",
          );
        } catch (error) {
          log(`Test failed: ${error.message}`);
          updateTestStatus(`Test failed: ${error.message}`, "error");
        } finally {
          runTestBtn.disabled = false;
        }
      }

      // Event listeners
      runTestBtn.addEventListener("click", runTest);
      clearLogsBtn.addEventListener("click", () => {
        logs.value = "";
        log("Logs cleared");
      });

      // Initialize
      log("Parallel Progress Test page loaded");
      updateTestStatus("Ready to run test", "info");
    </script>
  </body>
</html>
